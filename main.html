<!doctype html>
<html>

  <head>
    <meta charset="utf-8">
    <title>main</title>
    <link rel="stylesheet" type="text/css" href="style.css">

  </head>

  <body>
    <div class="menu">
      <div class="header">
        <h1>Blob Mob <i>the whole story</i></h1>
        <hr>
        <canvas id="animation" width="800" height="400">Click To start</canvas>
        <hr>
      </div>
      <div class="content-left">
        <h2>How to Play</h2>
      </div>
      <span class="divider"></span>
      <div class="content-right">
        <h2>About</h2>
      </div>
    </div>
    <div class="window">
      <canvas id="game" width="800" height="800">Sorry your browser does not support the HTML5 Canvas.</canvas>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
      const mc = document.getElementById("animation");
      const mctx = mc.getContext("2d");
      const menuVisible = $('#animation').is(':visible');
			var x = 0;
      var y = 0;

      if (menuVisible) {
        window.requestAnimationFrame(menuAnim);
      }
      
      function menuAnim() {
        mctx.clearRect(0,0,mc.width, mc.height);
        x = srandom(x)
        y = srandom(y);
      	mctx.fillStyle = 'black';
        mctx.font = "50px comic sans ms"
        const messg = "CLick to play";
        mctx.fillText(messg, mc.width/3 + x, mc.height/2 + y);
        if(menuVisible) window.requestAnimationFrame(menuAnim);
      }

      $('#animation').click(function() {
        $('.menu').fadeOut('slow', function() {
          $('.window').fadeIn('slow');
          $('body').css("background", "black");
          window.cancelAnimationFrame(menuAnim);
          window.requestAnimationFrame(main);
        });
      });

      const c = document.getElementById("game");
      const ctx = c.getContext("2d");
      var xMain;
      var sx = 100;
      var sy = 100;
      var wx = 50;
      var wy = 50;
      var w = c.width;
      var h = c.height;
      var randomColor = '#ffd6cc';
      var rDown = false;
      var lDown = false;
      var uDown = false;
      var dDown = false;
      var attackb = false;
      var attackz = false;
      var attackx = false;
      var power = 50;
      var cool = 0;
      var health = 100;
      var dead = false;
      var score = 0;
      var highscore = localStorage.getItem("highscore");
      var recent = 'right';
      var damaging;
      var speed = 1.5;
      var regeneration = false;
      var Otime = 0;

      //HELPER FUNCTIONS
      function random(a) {
        var rand = Math.random() * 10;
        if (rand - 5 > 0 && a < 60) return a + .5;
        else if (rand - 5 <= 0 && a > 40) return a - .5;
        else return a;
      }

      function srandom(a) {
        var rand = Math.random() * 10
        if (rand > 5) return a + 0.2;
        else return a - 0.2;
      }

      function mxrandom(a) {
        var rand = Math.random() * 10;
        if (rand > 5 && a < w - wx - 10) return a + 0.1;
        else if (rand <= 5 && a > 10) return a - 0.1;
        else return a;
      }

      function myrandom(a) {
        var rand = Math.random() * 10
        if (rand > 5 && a > 10) return a - 0.1;
        else if (rand <= 5 && a < h - wy - 10) return a + 0.1;
        else return a;
      }

      function resize() {
        // Lookup the size the browser is displaying the canvas.
        var cw = window.innerWidth;
        var ch = window.innerHeight;

        // Check if the canvas is not the same size.
        if (w != cw || h != ch) {

          // Make the canvas the same size
          c.width = cw - 18;
          c.height = ch - 22;
          sx = (sx * c.width) / w;
          w = c.width;
          h = c.height;
        }
      }
      //CHARACTER
      function drawChar() {
        randNum = Math.round(Math.random() * 2);
        //randomColor = colors[randNum];


        ctx.fillStyle = randomColor;
        ctx.fillRect(sx, sy, wx, wy);

        ctx.lineWidth = 1;

        ctx.beginPath();
        ctx.fillStyle = 'black';
        //Right Eye
        ctx.arc(sx + wx / 6, sy + wy / 6, (wx / 4 + wy / 4) / 4, 0, 2 * Math.PI);
        ctx.stroke();
        ctx.closePath();

        //Left Eye
        ctx.beginPath();
        ctx.arc(sx + wx - wx / 8, sy + wy / 6, (wx / 4 + wy / 4) / 6, 0, 2 * Math.PI);
        ctx.stroke();
        ctx.closePath();

        //Smile
        ctx.beginPath();
        ctx.moveTo(sx + wx / 8, sy + wy - wy / 4);
        //ctx.moveTo(sx + wx / 8, sy + wy - wy / 3);
        ctx.bezierCurveTo(sx + wy / 8, sy + wy / 2, sx + wx - wy / 8, sy + wy / 2, sx + wx - wy / 8, sy + wy - wy / 4);
        ctx.stroke();
        ctx.closePath();
      }

      function moveChar() {
        if (dDown && regeneration == false) {
          sy += speed;
          sx = random(sx);
          recent = 'down';
        }
        if (rDown && regeneration == false) {
          sx += speed;
          sy = random(sy)
          recent = 'right';
        }
        if (uDown && regeneration == false) {
          sy -= speed;
          sx = random(sx);
          recent = 'up';
        }
        if (lDown && regeneration == false) {
          sx -= speed;
          sy = random(sy);
          recent = 'left';
        }
        /*if (attackb && regeneration == false) {
        	clearInterval(sessionM);
        	attack();
        } else if (attackz && regeneration == false) {
        	clearInterval(sessionM);
        	attackZ();
        } else if (attackx == false){
        	regeneration = false;
        }
        */
        sx = srandom(sx);
        sy = srandom(sy);
        wx = random(wx);
        wy = random(wy);

      }

      function listen() {
        document.addEventListener("keydown", keyDownHandler, false);
        document.addEventListener("keyup", keyUpHandler, false);

        function keyDownHandler(e) {
          e.preventDefault();
          if (e.keyCode == 40 || e.keyCode == 83) dDown = true;
          if (e.keyCode == 39 || e.keyCode == 68) rDown = true;
          if (e.keyCode == 38 || e.keyCode == 87) uDown = true;
          if (e.keyCode == 37 || e.keyCode == 65) lDown = true;
          if (e.keyCode == 32 && cool == 0) attackb = true;
          else if (e.keyCode == 90 && cool == 0 && power >= 10) attackz = true;
          else if (e.keyCode == 88 && cool == 0 && power > 0) attackx = true;
        }

        function keyUpHandler(e) {
          if (e.keyCode == 40 || e.keyCode == 83) dDown = false;
          if (e.keyCode == 39 || e.keyCode == 68) rDown = false;
          if (e.keyCode == 38 || e.keyCode == 87) uDown = false;
          if (e.keyCode == 37 || e.keyCode == 65) lDown = false;
          if (e.keyCode == 88) attackx = false;
        }

      }

      function drawStage() {
        ctx.fillStyle = '#fffbf9';
        ctx.fillRect(0, 0, w, h);
        //ctx.drawImage(background, 0, 0, w, h);
        ctx.lineWidth = 10;
        ctx.strokeRect(0, 0, w, h);
      }

      function drawHealth() {
        ctx.fillStyle = 'black';
        ctx.fillRect(10, 10, w - 20, 20);
        ctx.fillStyle = randomColor;
        ctx.font = "10px monospace";
        ctx.fillText(health + "/100", w / 2 - 15, 23);
        ctx.fillRect(11, 11, (health / 100) * (w - 22), 18);
      }

      function drawCool() {
        ctx.fillStyle = 'black';
        ctx.fillRect(w / 2, 35, w / 4 - 2.5, 20);
        ctx.fillStyle = 'blue';
        ctx.fillRect(w / 2 + 1, 36, ((50 - cool) / 50) * (w / 4 - 5.25), 18);
      }

      function drawPower() {
        ctx.fillStyle = 'black';
        ctx.fillRect(w * 3 / 4 + 5, 35, w / 4 - 15.5, 20);
        ctx.fillStyle = '#33cc33';
        ctx.font = "10px monospace";
        ctx.fillText(power + "/50", w - w * (1 / 8) - 15, 49);
        ctx.fillRect(w - w * (1 / 4) + 6, 36, (power / 50) * (w / 4 - 17.5), 18);
      }

      function drawScore() {
        ctx.fillStyle = 'black';
        ctx.font = "20px monospace";
        ctx.fillText("Score: " + score, 18, 28, w / 2);
        ctx.fillText("High-Score: " + highscore, 18, 58, w / 2);
      }
      xMain = true;

      function main(timestamp) {
        ctx.clearRect(0, 0, w, h);
        resize(c);
        drawStage();
        drawHealth();
        drawPower();
        drawCool();
        listen();
        moveChar();
        drawChar();
        if (xMain) window.requestAnimationFrame(main);
      }

    </script>

  </body>

</html>
